pipeline {
    agent none

    options {
        buildDiscarder(logRotator(numToKeepStr: '4'))
        parallelsAlwaysFailFast()
        disableConcurrentBuilds()
    }

    stages {
        stage('Build') {
            parallel {
                stage ('linux') {
                    agent { label 'docker' }
                    steps {
                        sh '''
                               yarn install --non-interactive
                               yarn dist
                        '''
                        script{
                            if (env.BRANCH_NAME == 'master' || env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'neos') {
                                sh '''
                                    yarn docker-build
                                '''
                            }
                        }
                    }
                }
            }
        }
        stage('Deploy') {
            parallel {
                stage ('linux') {
                    agent { label 'docker' }
                    options {
                        skipDefaultCheckout()
                    }
                    steps {
                        script{
                            if (env.BRANCH_NAME == 'master') {
                                withCredentials([usernamePassword(credentialsId: 'dockerhub_login', passwordVariable: 'hub_pass', usernameVariable: 'hub_user')]){
                                    sh '''
                                        docker login hub.gams.com:443 --username="${hub_user}" --password="${hub_pass}"
                                        yarn docker-publish
                                    '''
                                }
                            } else if (env.BRANCH_NAME == 'develop' || env.BRANCH_NAME == 'neos') {
                                withCredentials([usernamePassword(credentialsId: 'dockerhub_login', passwordVariable: 'hub_pass', usernameVariable: 'hub_user')]){
                                    sh '''
                                        docker login hub.gams.com:443 --username="${hub_user}" --password="${hub_pass}"
                                        yarn docker-publish-unstable
                                    '''
                                }
                            }
                        }
                        archiveArtifacts artifacts: 'dist/*.AppImage', fingerprint: true
                    }
                }
            }
        }
    }
}
